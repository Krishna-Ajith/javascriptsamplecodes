<?php
elgg_load_css("fitness_css");

elgg_load_library("shn:lib");
elgg_load_library("shn:lib:deviceservices");
elgg_load_library("shn:model:devices");

$memberinfo = elgg_extract('memberinfo', $vars, '');
$today = elgg_extract('today', $vars, '');
$today = ($today=='')?  date('Y-m-d') : $today;


$guid =  $memberinfo['guid'];

elgg_load_library("shn:model:users");
$targetUser = SHNUser::loadByGuid($guid);
$user_id = $targetUser->getId();


$calories_consumed = Fitness::getMemberCalories($user_id);

$device =  shn_get_user_devices($guid);


$activity = DeviceServices::getDailyActivity($device[0]->device_user_device_id);
$calories_burned = ($activity['caloriesOut']=='')? '0' : $activity['caloriesOut'];

?>


<div class="content">
    <div class="nutrition_date">
        <input type="text" id="datepicker" value="<?php echo $today?>" />
    </div>
    <?php


    if($userstat['calories_goal']!=''){

        $calory_goal = $userstat['calories_goal'];
        echo '<div class="plantitle"> <div>My Calories Summary </div><span class="clear"></span></div>';
        echo    '<div class="calsum">
                <div class="calind"> Calories goal  <br /> <span class="calgoal">'.$calory_goal .'</span></div>
                <div class="calind"> Calories Consumed  <br /> <span class="calgoal" id="cal_consumed"> '.number_format($calories_consumed,2) .'</span></div>
                <div class="calind"> Calories Burned  <br /> <span class="calgoal"> '.$calories_burned.'</span></div>
                <div class="calind"> Calories Left  <br /> <span class="calgoal" id="cal_left" style="color: #70B646;">'.number_format(($calory_goal-$calories_consumed+$calories_burned), 2) .'</span></div>
            </div>';
    }else{
        $calory_goal = 0;
        echo '<div class="nutritionalert">You don\'t have Calories Goal ';
        echo '<a href="'.elgg_get_site_url().'hra/"> Retake HRA </a> </div>';
        echo '<div class="plantitle"> <div>My Calories Summary </div><span class="clear"></span></div>';
        echo    '<div class="calsum">
                <div class="calind"> Calories goal  <br /> <span class="calgoal">'.$calory_goal .'</span></div>
                <div class="calind"> Calories Consumed  <br /> <span class="calgoal" id="cal_consumed"> '.number_format($calories_consumed,2) .'</span></div>
                <div class="calind"> Calories Burned  <br /> <span class="calgoal"> '.$calories_burned .' </span></div>
                <div class="calind"> Calories Left  <br /> <span class="calgoal" id="cal_left">'.number_format(($calory_goal-$calories_consumed+$calories_burned), 2) .'</span></div>
            </div>';

    }



    ?>
    <script>
        function calcPath (value, total, R) {
            var center;
            var alpha = 360 / total * value,
                a = (90 - alpha) * Math.PI / 180,
                x = 70 + R * Math.cos(a),
                y = 70 - R * Math.sin(a),
                path;
            if (total == value) {
                path = "M"+ 70 +","+ (70 - R) +" A"+ R+","+ R+","+ 0+","+ 1+","+ 1+","+ 69.99+","+ 70 - R;
            } else {
                if(alpha > 180) {
                    center = 1;
                } else {
                    center = 0;
                }
                path = "M"+ 70+","+ (70 - R) +" A"+ R+","+ R+","+ 0+"," + center +","+ 1+","+ x+","+ y;
            }

            return path;
        }


        function updatePath(progress_id,  value, total, color){
            if(value<total){
                path = calcPath(value, total, 50);
            }else{
                path = calcPath(total-0.1, total, 50);
            }
            $('#'+progress_id+'_progress').html('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"><path d="M70,20 A50,50,0,1,1,66.86047402353434,20.098663578586425"   fill="none" stroke="#DFDFDF" stroke-width="10" /> <path d="'+path+'"   fill="none" stroke="'+color+'" stroke-linejoin="round"   stroke-width="10" stroke-dasharray="10,2"/> </svg>');
            $('#'+progress_id+'_actual').html(value);

        }


        jQuery(document).ready(function() {

            <?php
            $distance = $activity['totalDistance'];
            if($distance!='') {
                 echo 'var distance_value=0;';
                 echo 'var distance_actual = '.$distance.';';
                 echo 'var distance_intvar = setInterval(distanceUpdate, 20);';
             }

            $step = $activity['steps'];
            if($step!='') {
                 echo 'var step_value=0;';
                 echo 'var step_actual = '.$step.';';
                 echo 'var step_intvar = setInterval(stepUpdate, 20);';
             }

            $floor = $activity['floors'];
            if($floor!='') {
                 echo 'var floor_value=0;';
                 echo 'var floor_actual = '.$floor.';';
                 echo 'var floor_intvar = setInterval(floorUpdate, 100);';
             }


             ?>

            function distanceUpdate(){
                distance_value = distance_value +0.1;
                updatePath('distance', Number(distance_value).toFixed(2), 10, '#007DC0');
                if(distance_value>distance_actual){
                    clearInterval(distance_intvar);
                    updatePath('distance', distance_actual, 10, '#007DC0');
                }
            }

            function stepUpdate(){
                step_value = step_value+50;
                updatePath('step', step_value, 10000, 'green');
                if(step_value>step_actual) {
                    clearInterval(step_intvar);
                    updatePath('step', step_actual, 10000, 'green');
                }
            }

            function floorUpdate(){
                floor_value = floor_value + 1;
                updatePath('floor', Number(floor_value), 20, 'red');
                if(floor_value>floor_actual) {
                    clearInterval(floor_intvar);
                    updatePath('floor', floor_actual, 20, 'red');
                }
            }



        });
    </script>
    <div class="plantitle"> <div>Activity [Daily Goal] </div><span class="clear"></span></div>
    <div class="activity">
        <div class="calind">
            <h2>MILES [10]</h2>
            <div class="distance_chart">

                <span id="distance_progress" ></span>

            </div> <br />
            <span class="percentage"><?=number_format(($activity['totalDistance']/10)*100, 1)?>%</br></span>
            <span id="distance_actual" class="calgoal"><?=$activity['totalDistance']?></span>
        </div>

        <div class="calind">
            <h2>FLOORS [20]</h2>
            <div class="floor_chart">
                <span id="floor_progress" ></span>
            </div><br />
            <span class="percentage"><?=number_format(($activity['floors']/20)*100, 1)?>%</br></span>
            <span id="floor_actual" class="calgoal"><?=$activity['floors']?></span>

        </div>

        <div class="calind">
            <h2>STEPS [10000]</h2>
            <div class="step_chart">
                <span id="step_progress" ></span>
            </div><br />
            <span class="percentage"><?=number_format(($activity['steps']/10000)*100, 1)?>%</br></span>

            <span id="step_actual" class="calgoal"><?=$activity['steps']?></span>
        </div>
        <div class="calind">
            <h2>CALORIES  [<?=$calory_goal?>]</h2>
            <div class="calories_chart">
                <span id="calories_progress" ></span>
            </div><br />

            <span class="percentage" id="" ><?php echo ($calories_goal!=0)? number_format(($calories_burned/$calories_goal)*100, 1).'%' : 'N/A'; ?></br> </span>
            <span id="calories_actual" class="calgoal"><?=$calories_burned?></span>
        </div>
    </div>



</div>
